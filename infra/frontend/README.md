# Vitality Frontend Infrastructure

> **Architecture Documentation**: For detailed architecture information, see the [Frontend Architecture Documentation](../../arch/frontend/).

This directory contains the Terraform configuration for deploying the Next.js frontend application to AWS S3 and CloudFront with WAF protection.

## Architecture

The frontend deployment consists of:

- **S3 Bucket**: Stores the static assets generated by Next.js
- **CloudFront Distribution**: CDN for fast global content delivery
- **WAF Web ACL**: Protection against common web exploits and attacks
- **Origin Access Identity**: Secure access to S3 from CloudFront only

## Deployment Process

1. **Configure Variables**:

```bash
# Copy the example variables file
cp terraform.tfvars.example terraform.tfvars

# Edit the variables as needed
nano terraform.tfvars
```

2. **Setup Infrastructure**:

```bash
# Initialize Terraform
terraform init

# Review changes
terraform plan

# Apply changes
terraform apply
```

3. **Deploy Frontend Application**:

```bash
# Make the script executable (if needed)
chmod +x deploy.sh

# Run the deployment script
./deploy.sh
```

The deployment script will:
- Build the Next.js application
- Export it to static HTML
- Upload the files to the S3 bucket
- Invalidate the CloudFront cache

## Infrastructure Components

### S3 Bucket

The S3 bucket is configured with:
- Private ACL
- Versioning enabled
- Blocked public access
- Policy allowing access only from CloudFront

### CloudFront Distribution

The CloudFront distribution is configured with:
- S3 origin for static assets
- API origin for backend API requests
- HTTPS only
- Custom error responses for SPA routing
- WAF integration

### WAF Web ACL

The WAF is configured with AWS managed rule sets:
- AWS Common Rule Set (Core rule set)
- Known Bad Inputs Rule Set

## Configuration

You can customize the deployment by modifying the `terraform.tfvars` file. Here are the available variables:

| Variable | Description | Default |
|----------|-------------|---------|
| namespace | Organization namespace | "vitality" |
| stage | Environment stage | "dev" |
| name | Application name | "frontend" |
| attributes | Additional attributes | ["app"] |
| region | AWS region | "us-west-2" |
| price_class | CloudFront price class | "PriceClass_100" |
| s3_origin_id | S3 origin ID | "S3Origin" |
| api_origin_id | API origin ID | "APIOrigin" |
| api_service_name | App Runner service name | "${namespace}-${stage}-api-service" |
| tags | Resource tags | {} |

## Price Class Options

CloudFront price classes determine which edge locations your content is distributed to:

- **PriceClass_100**: US, Canada, Europe
- **PriceClass_200**: Above + South America, Australia, Japan, Singapore, Hong Kong, etc.
- **PriceClass_All**: All CloudFront edge locations globally

Choose based on your target audience and budget requirements. 